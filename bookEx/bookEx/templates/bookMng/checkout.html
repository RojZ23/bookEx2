{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<div style="max-width: 800px; margin: 2rem auto; background: var(--bg-secondary); border-radius: 12px; padding: 2rem 2.5rem; box-shadow: var(--shadow);">
  <h2 style="font-weight: 700; color: var(--primary); margin-bottom: 2rem;">Checkout</h2>

  {% if cart_items %}
    <table style="width: 100%; border-collapse: collapse; text-align: center; font-size: 1rem;">
      <thead>
        <tr style="background: var(--primary); color: white; height: 40px;">
          <th style="padding: 0 10px;">Image</th>
          <th style="padding: 0 10px; text-align: left;">Title</th>
          <th style="padding: 0 10px;">Rating</th>
          <th style="padding: 0 10px;">Quantity</th>
          <th style="padding: 0 10px;">Unit Price</th>
          <th style="padding: 0 10px;">Total</th>
        </tr>
      </thead>
      <tbody>
        {% for item in cart_items %}
        <tr style="background: var(--bg-primary); height: 110px;">
          <td style="padding: 8px;">
            <img src="{{ item.book.picture.url }}" alt="{{ item.book.name }}" style="width: 70px; height: 100px; object-fit: cover; border-radius: 6px;">
          </td>
          <td style="font-weight: 600; text-align: left; padding-left: 15px;">
            <a href="{% url 'book_detail' item.book.id %}" style="color: var(--primary); text-decoration: none;">
              {{ item.book.name }}
            </a>
          </td>
          <td style="vertical-align: middle; padding: 8px 10px;">
            {% for i in "12345" %}
              {% if i|add:'0' <= item.book.average_rating %}
                <span style="color:#FFD700; font-size: 1.2rem;">&#9733;</span>
              {% else %}
                <span style="color:#ccc; font-size: 1.2rem;">&#9733;</span>
              {% endif %}
            {% endfor %}
            <br><small>({{ item.book.average_rating|floatformat:1 }}/5)</small>
          </td>
          <td style="padding: 8px 10px;">
            <form method="post" action="{% url 'update_cart_quantity' item.book.id %}" style="display: inline-block;">
              {% csrf_token %}
              <input type="number" name="quantity" value="{{ item.quantity }}" min="1" style="width: 55px; padding: 4px; border-radius: 4px; border: 1px solid var(--border); text-align:center;">
              <button type="submit" style="padding: 5px 12px; margin-left: 5px; border-radius: 4px; background: var(--primary); color: white; border: none; cursor: pointer;">
                Update
              </button>
            </form>
          </td>
          <td style="padding: 8px 10px; font-weight: 600;">
            ${{ item.book.price }}
          </td>
          <td style="padding: 8px 10px; font-weight: 700; color: var(--primary);">
            ${{ item.quantity|mul:item.book.price|floatformat:2 }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <hr style="margin: 2rem 0; border: 1px solid var(--border);">

    <p style="font-weight: 700; font-size: 1.3rem; text-align: right; margin: 0;">
      Total: ${{ total_price|floatformat:2 }}
    </p>

    <div style="margin-top: 2rem; display: flex; gap: 12px; justify-content: flex-end;">
      <form method="post" action="{% url 'checkout' %}">
        {% csrf_token %}
        <button type="submit" style="padding: 12px 28px; font-weight: 700; font-size: 1rem; border: none; border-radius: 8px; background: var(--primary); color: white; cursor: pointer;">
          Confirm Purchase
        </button>
      </form>

      <form method="post" action="{% url 'cancel_checkout' %}">
        {% csrf_token %}
        <button type="submit" style="padding: 12px 28px; font-weight: 700; font-size: 1rem; border-radius: 8px; background: var(--text-secondary); color: white; border: none; cursor: pointer;">
          Cancel
        </button>
      </form>
    </div>

{% else %}
<div style="max-width: 400px; margin: 4rem auto; text-align: center; color: var(--text-secondary); font-style: italic; font-size: 1.3rem; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
  <img src="https://media.istockphoto.com/id/861576608/vector/empty-shopping-bag-icon-online-business-vector-icon-template.jpg?s=612x612&w=0&k=20&c=I7MbHHcjhRH4Dy0NVpf4ZN4gn8FVDnwn99YdRW2x5k0=" alt="Empty cart icon" style="max-width: 240px; margin-bottom: 2rem; opacity: 0.75;">
  <p>Your cart is empty.</p>
</div>
{% endif %}

</div>
{% endblock %}

{% extends 'base.html' %}
{% load static custom_filters %}


{% block content %}
<style>
 .mybooks-section {
   width: 100%;
   max-width: 1200px;
   margin: 0 auto;
   padding: var(--space-lg);
 }

 .mybooks-header {
   display: flex;
   flex-wrap: wrap;
   gap: var(--space-lg);
   align-items: center;
   justify-content: space-between;
   margin-bottom: var(--space-lg);
 }

 .welcome-text {
   font-size: 1.1rem;
   color: #9ca3af;
 }

 .welcome-text strong {
   color: #e5e7eb;
   font-weight: 500;
 }

 .search-container {
   display: flex;
   gap: var(--space-xs);
 }

 .search-input {
   border: 1px solid rgba(148, 163, 184, 0.5);
   border-radius: var(--radius-full);
   padding: 10px 16px;
   font-size: 0.95rem;
   background: rgba(15, 23, 42, 0.8);
   color: #e5e7eb;
   backdrop-filter: blur(24px);
 }

 .search-input:focus {
   outline: none;
   border-color: rgba(129, 140, 248, 0.7);
   box-shadow: 0 0 0 2px rgba(129, 140, 248, 0.2);
 }

 .search-button {
   background: radial-gradient(circle at top left, #4f46e5, #2563eb);
   color: #e5e7eb;
   border: none;
   border-radius: var(--radius-full);
   padding: 10px 18px;
   font-weight: 500;
   cursor: pointer;
   transition: all 0.3s ease;
   box-shadow: 0 6px 14px rgba(37, 99, 235, 0.4);
 }

 .search-button:hover {
   transform: translateY(-1px);
   box-shadow: 0 8px 20px rgba(37, 99, 235, 0.6);
 }

 .post-book-button {
   background: radial-gradient(circle at top left, #4f46e5, #2563eb);
   padding: 10px 20px;
   border-radius: var(--radius-full);
   color: white;
   font-weight: 600;
   font-size: 0.95rem;
   text-decoration: none;
   box-shadow: 0 8px 20px rgba(37, 99, 235, 0.5);
   transition: all 0.3s ease;
 }

 .post-book-button:hover {
   transform: translateY(-1px);
   box-shadow: 0 12px 25px rgba(37, 99, 235, 0.7);
 }

 .stats-container {
   display: flex;
   gap: var(--space-md);
   justify-content: start;
   margin-bottom: var(--space-lg);
   flex-wrap: wrap;
 }

 .stat-item {
   background: rgba(15, 23, 42, 0.9);
   border: 1px solid rgba(148, 163, 184, 0.3);
   border-radius: 12px;
   padding: 12px 20px;
   font-size: 0.95rem;
   color: #a5b4fc;
   box-shadow: 0 8px 25px rgba(15, 23, 42, 0.8);
   backdrop-filter: blur(24px);
 }

 .stat-item strong {
   color: #e5e7eb;
 }

 .mybooks-grid {
   display: grid;
   grid-template-columns: repeat(3, 1fr);
   gap: 30px;
   align-items: start;
   min-height: 400px;
 }

 @media (max-width: 1024px) {
   .mybooks-grid {
     grid-template-columns: repeat(2, 1fr);
   }
 }

 @media (max-width: 768px) {
   .mybooks-grid {
     grid-template-columns: 1fr;
   }
 }

 .books-column {
   text-align: left;
 }

 .column-title {
   font-weight: 700;
   font-size: 1.3rem;
   color: #e5e7eb;
   margin-bottom: var(--space-md);
   display: flex;
   align-items: center;
   gap: var(--space-sm);
 }

 .column-title::before {
   content: "";
   width: 4px;
   height: 20px;
   background: linear-gradient(120deg, #60a5fa, #a855f7, #22c55e);
   border-radius: var(--radius-full);
 }

 .books-list {
   display: flex;
   flex-direction: column;
   gap: var(--space-sm);
   margin-bottom: var(--space-md);
 }

 .book-card {
   min-height: 120px;
   display: flex;
   align-items: center;
   justify-content: space-between;
   background: rgba(15, 23, 42, 0.8);
   border: 1px solid rgba(148, 163, 184, 0.3);
   border-radius: 12px;
   padding: var(--space-md);
   transition: all 0.3s ease;
   cursor: pointer;
   backdrop-filter: blur(24px);
   box-shadow: 0 8px 25px rgba(15, 23, 42, 0.7);
 }

 .book-card:hover {
   transform: translateY(-2px);
   border-color: rgba(129, 140, 248, 0.5);
   box-shadow: 0 12px 30px rgba(15, 23, 42, 0.9);
 }

 .book-content {
   display: flex;
   align-items: center;
   gap: var(--space-md);
   flex: 1;
 }

 .book-image {
   height: 80px;
   width: 55px;
   object-fit: cover;
   border-radius: 6px;
   box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
 }

 .book-info {
   flex: 1;
 }

 .book-name {
   color: #e5e7eb;
   font-weight: 600;
   font-size: 1rem;
   text-decoration: none;
   transition: color 0.2s ease;
 }

 .book-name:hover {
   color: #a5b4fc;
 }

 .exclusive-badge {
   position: relative;
   top: -1px;
   background: gold;
   color: black;
   font-weight: 700;
   font-size: 0.7rem;
   padding: 2px 6px;
   border-radius: 4px;
   box-shadow: 0 0 5px rgba(218, 165, 32, 0.7);
   margin-left: 6px;
   user-select: none;
   display: inline-block;
 }

 .book-description {
   color: #9ca3af;
   font-size: 0.85rem;
   margin-top: 4px;
   max-width: 200px;
   overflow: hidden;
   text-overflow: ellipsis;
   display: -webkit-box;
   -webkit-line-clamp: 2;
   -webkit-box-orient: vertical;
 }

 .book-actions {
   display: flex;
   flex-direction: column;
   gap: var(--space-xs);
   align-items: flex-end;
 }

 .delete-button {
   background: #dc3545;
   color: white;
   padding: 6px 12px;
   border-radius: 8px;
   border: none;
   cursor: pointer;
   font-size: 0.9rem;
   font-weight: 600;
   transition: all 0.2s ease;
   box-shadow: 0 4px 10px rgba(220, 53, 69, 0.3);
 }

 .delete-button:hover {
   background: #bb2d3b;
   transform: translateY(-1px);
   box-shadow: 0 6px 14px rgba(220, 53, 69, 0.4);
 }

 .return-button {
   background: #4f46e5;
   color: white;
   padding: 6px 12px;
   border-radius: 8px;
   border: none;
   cursor: pointer;
   font-size: 0.9rem;
   font-weight: 600;
   transition: all 0.2s ease;
   box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
 }

 .return-button:hover {
   background: #4338ca;
   transform: translateY(-1px);
   box-shadow: 0 6px 14px rgba(79, 70, 229, 0.4);
 }

 .purchased-quantity {
   margin-top: 5px;
   font-weight: 600;
   color: #9ca3af;
   font-size: 0.9rem;
 }

 .empty-state {
   font-style: italic;
   color: #9ca3af;
   font-size: 0.95rem;
   margin-top: var(--space-sm);
   text-align: center;
   padding: var(--space-md);
   background: rgba(15, 23, 42, 0.5);
   border-radius: 12px;
   border: 1px dashed rgba(148, 163, 184, 0.3);
 }

 .tip-box {
   margin-top: var(--space-md);
   background: rgba(15, 23, 42, 0.9);
   border: 1px solid rgba(148, 163, 184, 0.3);
   border-radius: 12px;
   padding: var(--space-md);
   font-size: 0.9rem;
   color: #9ca3af;
   backdrop-filter: blur(24px);
   box-shadow: 0 8px 25px rgba(15, 23, 42, 0.7);
 }

 .tip-box strong {
   color: #a5b4fc;
 }
</style>

<section class="mybooks-section">
   <!-- Header Section -->
   <div class="mybooks-header">
       <div class="welcome-text">
           <strong>Welcome, {{ user.username }}!</strong>
           <span style="margin-left:12px;">Manage your personal book exchange dashboard.</span>
       </div>
       <div class="search-container">
           <input type="text" placeholder="Search all your books..." id="myBooksSearch" class="search-input" />
           <button type="button" class="search-button" onclick="document.getElementById('myBooksSearch').focus();">
               Search
           </button>
       </div>
       <a href="{% url 'postbook' %}" class="post-book-button">
           + Post New Book
       </a>
   </div>

   <!-- Stats Section -->
   <div class="stats-container">
       <div class="stat-item">
           <i class="fas fa-book-open" style="margin-right:6px;"></i>
           Posted: <strong>{{ posted_books|length }}</strong>
       </div>
       <div class="stat-item">
           <i class="fas fa-shopping-cart" style="margin-right:6px;"></i>
           Purchased: <strong>{{ total_purchased_qty }}</strong>
       </div>
       <div class="stat-item">
           <i class="fas fa-heart" style="margin-right:6px;"></i>
           Favorites: <strong>{{ favorite_books|length }}</strong>
       </div>
   </div>

   <!-- Main Grid -->
   <div class="mybooks-grid">
       <!-- Books You Posted -->
       <div class="books-column">
           <h2 class="column-title">Books You Posted</h2>
           <div id="postedBooksList" class="books-list">
           {% if posted_books %}
               {% for book in posted_books %}
               <div class="book-card" data-bookname="{{ book.name|lower }}">
                   <div class="book-content">
                       <img src="{{ book.picture.url }}" alt="{{ book.name }}" class="book-image" />
                       <div class="book-info">
                         {% if book.is_exclusive %}
                         <a href="{% url 'exclusive_book_detail' book.id %}" class="book-name">
                             {{ book.name }}<span class="exclusive-badge">EXCLUSIVE</span>
                         </a>
                         {% else %}
                         <a href="{% url 'book_detail' book.id %}" class="book-name">
                             {{ book.name }}
                         </a>
                         {% endif %}
                         {% if book.description %}
                         <p class="book-description">
                           {{ book.description|truncatechars:50 }}
                         </p>
                         {% endif %}
                       </div>
                   </div>
                   <div class="book-actions">
                       <form method="post" action="{% url 'book_delete' book.id %}">
                           {% csrf_token %}
                           <button type="submit" class="delete-button">
                               Delete
                           </button>
                       </form>
                   </div>
               </div>
               {% endfor %}
           {% else %}
           <div class="empty-state">
               You haven't posted any books yet.<br />
               Use the 'Post Book' section to share your collection and start exchanging!
           </div>
           {% endif %}
           </div>
           <div class="tip-box">
               <strong>Tip:</strong> Keep your listings updated to attract more readers. You can edit or delete posted books easily.
           </div>
       </div>

       <!-- Books You Purchased -->
       <div class="books-column">
           <h2 class="column-title">Books You Purchased</h2>
           <div id="purchasedBooksList" class="books-list">
           {% if purchased_books %}
               {% for book in purchased_books %}
               <div class="book-card" data-bookname="{{ book.name|lower }}">
                   <div class="book-content">
                       <img src="{{ book.picture.url }}" alt="{{ book.name }}" class="book-image" />
                       <div class="book-info">
                         {% if book.is_exclusive %}
                         <a href="{% url 'exclusive_book_detail' book.id %}" class="book-name">
                             {{ book.name }} <span class="exclusive-badge">EXCLUSIVE</span>
                         </a>
                         {% else %}
                         <a href="{% url 'book_detail' book.id %}" class="book-name">
                             {{ book.name }}
                         </a>
                         {% endif %}
                         {% if book.description %}
                         <p class="book-description">
                           {{ book.description|truncatechars:50 }}
                         </p>
                         {% endif %}
                         <div class="purchased-quantity">
                             Purchased: {{ purchased_quantities|get_item:book.id|default:'0' }}
                         </div>
                         {% if purchased_quantities|get_item:book.id|default:0 > 0 %}
                         <form method="get" action="{% url 'return_book' book.id %}" style="margin-top: 7px;">
                             <button type="submit" class="return-button">
                                 Return
                             </button>
                         </form>
                         {% endif %}
                       </div>
                   </div>
               </div>
               {% endfor %}
           {% else %}
           <div class="empty-state">
               You haven't purchased any books yet.<br />
               Explore our catalog to find books and add them to your collection!
           </div>
           {% endif %}
           </div>
           <div class="tip-box">
               <strong>Did you know?</strong> Purchases are tracked automatically. You can return books conveniently using the return option.
           </div>
       </div>

       <!-- Your Favorite Books -->
       <div class="books-column">
           <h2 class="column-title">Your Favorite Books</h2>
           <div id="favoriteBooksList" class="books-list">
           {% if favorite_books %}
               {% for book in favorite_books %}
               <div class="book-card" data-bookname="{{ book.name|lower }}">
                   <div class="book-content">
                       <div class="book-info">
                         {% if book.is_exclusive %}
                         <a href="{% url 'exclusive_book_detail' book.id %}" class="book-name">
                             {{ book.name }} <span class="exclusive-badge">EXCLUSIVE</span>
                         </a>
                         {% else %}
                         <a href="{% url 'book_detail' book.id %}" class="book-name">
                             {{ book.name }}
                         </a>
                         {% endif %}
                       </div>
                       <img src="{{ book.picture.url }}" alt="{{ book.name }}" class="book-image" />
                   </div>
               </div>
               {% endfor %}
           {% else %}
           <div class="empty-state">
               You have no favorite books yet.<br />
               Mark books as favorites to keep track of must-read titles and recommendations.
           </div>
           {% endif %}
           </div>
           <div class="tip-box">
               <strong>Tip:</strong> Use the favorite feature as your personal bookshelf to quickly find and revisit titles you love.
           </div>
       </div>
   </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
   const searchInput = document.getElementById('myBooksSearch');
   const postedCards = document.querySelectorAll('#postedBooksList .book-card');
   const purchasedCards = document.querySelectorAll('#purchasedBooksList .book-card');
   const favoriteCards = document.querySelectorAll('#favoriteBooksList .book-card');

   function filterMyBooks() {
       const term = searchInput.value.trim().toLowerCase();
       postedCards.forEach(card => {
           const bookname = card.getAttribute('data-bookname');
           card.style.display = (!term || bookname.includes(term)) ? '' : 'none';
       });
       purchasedCards.forEach(card => {
           const bookname = card.getAttribute('data-bookname');
           card.style.display = (!term || bookname.includes(term)) ? '' : 'none';
       });
       favoriteCards.forEach(card => {
           const bookname = card.getAttribute('data-bookname');
           card.style.display = (!term || bookname.includes(term)) ? '' : 'none';
       });
   }
   searchInput.addEventListener('input', filterMyBooks);
});
</script>
{% endblock content %}